import{r as ze,c as Oi,o as Ki,a as Ii,b as ue,t as Ft,d as qi}from"./index-iizdBJ8d.js";function Di(e){return e!==null?{comment:e,variations:[]}:{variations:[]}}function Li(e,t,n,i,r){const o={move:e,variations:r};return t&&(o.suffix=t),n&&(o.nag=n),i!==null&&(o.comment=i),o}function Ri(...e){const[t,...n]=e;let i=t;for(const r of n)r!==null&&(i.variations=[r,...r.variations],r.variations=[],i=r);return t}function Fi(e,t){if(t.marker&&t.marker.comment){let n=t.root;for(;;){const i=n.variations[0];if(!i){n.comment=t.marker.comment;break}n=i}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function Bi(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}function Ce(e,t,n,i){var r=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(r,Ce.prototype),r.expected=t,r.found=n,r.location=i,r.name="SyntaxError",r}Bi(Ce,Error);function Ve(e,t,n){return n=n||" ",e.length>t?e:(t-=e.length,n+=n.repeat(t),e+n.slice(0,t))}Ce.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var n=null,i;for(i=0;i<e.length;i++)if(e[i].source===this.location.source){n=e[i].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(r):r,s=this.location.source+":"+o.line+":"+o.column;if(n){var a=this.location.end,f=Ve("",o.line.toString().length," "),c=n[r.line-1],p=r.line===a.line?a.column:c.length+1,g=p-r.column||1;t+=`
 --> `+s+`
`+f+` |
`+o.line+" | "+c+`
`+f+" | "+Ve("",r.column-1," ")+Ve("",g,"^")}else t+=`
 at `+s}return t};Ce.buildMessage=function(e,t){var n={literal:function(c){return'"'+r(c.text)+'"'},class:function(c){var p=c.parts.map(function(g){return Array.isArray(g)?o(g[0])+"-"+o(g[1]):o(g)});return"["+(c.inverted?"^":"")+p.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(c){return c.description}};function i(c){return c.charCodeAt(0).toString(16).toUpperCase()}function r(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+i(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+i(p)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+i(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+i(p)})}function s(c){return n[c.type](c)}function a(c){var p=c.map(s),g,m;if(p.sort(),p.length>0){for(g=1,m=1;g<p.length;g++)p[g-1]!==p[g]&&(p[m]=p[g],m++);p.length=m}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function f(c){return c?'"'+r(c)+'"':"end of input"}return"Expected "+a(e)+" but "+f(t)+" found."};function Ui(e,t){t=t!==void 0?t:{};var n={},i=t.grammarSource,r={pgn:Kt},o=Kt,s="[",a='"',f="]",c=".",p="O-O-O",g="O-O",m="0-0-0",v="0-0",b="$",w="{",A="}",x=";",T="(",le=")",_e="1-0",W="0-1",be="1/2-1/2",we="*",$=/^[a-zA-Z]/,te=/^[^"]/,R=/^[0-9]/,j=/^[.]/,ce=/^[a-zA-Z1-8\-=]/,On=/^[+#]/,wt=/^[!?]/,yt=/^[^}]/,Ct=/^[^\r\n]/,St=/^[ \t\r\n]/,Kn=z("tag pair"),In=I("[",!1),kt=I('"',!1),qn=I("]",!1),Dn=z("tag name"),je=Y([["a","z"],["A","Z"]],!1,!1),Ln=z("tag value"),Et=Y(['"'],!0,!1),Rn=z("move number"),Te=Y([["0","9"]],!1,!1),Fn=I(".",!1),Pt=Y(["."],!1,!1),Bn=z("standard algebraic notation"),Un=I("O-O-O",!1),Hn=I("O-O",!1),Wn=I("0-0-0",!1),jn=I("0-0",!1),At=Y([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Qn=Y(["+","#"],!1,!1),zn=z("suffix annotation"),$t=Y(["!","?"],!1,!1),Vn=z("NAG"),Gn=I("$",!1),Zn=z("brace comment"),Yn=I("{",!1),Mt=Y(["}"],!0,!1),Xn=I("}",!1),Jn=z("rest of line comment"),ei=I(";",!1),xt=Y(["\r",`
`],!0,!1),ti=z("variation"),ni=I("(",!1),ii=I(")",!1),ri=z("game termination marker"),oi=I("1-0",!1),si=I("0-1",!1),ai=I("1/2-1/2",!1),li=I("*",!1),ci=z("whitespace"),Tt=Y([" ","	","\r",`
`],!1,!1),fi=function(l,h){return Fi(l,h)},ui=function(l){return Object.fromEntries(l)},hi=function(l,h){return[l,h]},di=function(l,h){return{root:l,marker:h}},pi=function(l,h){return Ri(Di(l),...h.flat())},gi=function(l,h,d,C,S){return Li(l,h,d,C,S)},mi=function(l){return l},vi=function(l){return l.replace(/[\r\n]+/g," ")},_i=function(l){return l.trim()},bi=function(l){return l},wi=function(l,h){return{result:l,comment:h}},u=t.peg$currPos|0,ye=[{line:1,column:1}],Z=u,Ne=t.peg$maxFailExpected||[],_=t.peg$silentFails|0,Se;if(t.startRule){if(!(t.startRule in r))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=r[t.startRule]}function I(l,h){return{type:"literal",text:l,ignoreCase:h}}function Y(l,h,d){return{type:"class",parts:l,inverted:h,ignoreCase:d}}function yi(){return{type:"end"}}function z(l){return{type:"other",description:l}}function Nt(l){var h=ye[l],d;if(h)return h;if(l>=ye.length)d=ye.length-1;else for(d=l;!ye[--d];);for(h=ye[d],h={line:h.line,column:h.column};d<l;)e.charCodeAt(d)===10?(h.line++,h.column=1):h.column++,d++;return ye[l]=h,h}function Ot(l,h,d){var C=Nt(l),S=Nt(h),P={source:i,start:{offset:l,line:C.line,column:C.column},end:{offset:h,line:S.line,column:S.column}};return P}function y(l){u<Z||(u>Z&&(Z=u,Ne=[]),Ne.push(l))}function Ci(l,h,d){return new Ce(Ce.buildMessage(l,h),l,h,d)}function Kt(){var l,h,d;return l=u,h=Si(),d=Pi(),l=fi(h,d),l}function Si(){var l,h,d;for(l=u,h=[],d=It();d!==n;)h.push(d),d=It();return d=F(),l=ui(h),l}function It(){var l,h,d,C,S,P,fe;return _++,l=u,F(),e.charCodeAt(u)===91?(h=s,u++):(h=n,_===0&&y(In)),h!==n?(F(),d=ki(),d!==n?(F(),e.charCodeAt(u)===34?(C=a,u++):(C=n,_===0&&y(kt)),C!==n?(S=Ei(),e.charCodeAt(u)===34?(P=a,u++):(P=n,_===0&&y(kt)),P!==n?(F(),e.charCodeAt(u)===93?(fe=f,u++):(fe=n,_===0&&y(qn)),fe!==n?l=hi(d,S):(u=l,l=n)):(u=l,l=n)):(u=l,l=n)):(u=l,l=n)):(u=l,l=n),_--,l===n&&_===0&&y(Kn),l}function ki(){var l,h,d;if(_++,l=u,h=[],d=e.charAt(u),$.test(d)?u++:(d=n,_===0&&y(je)),d!==n)for(;d!==n;)h.push(d),d=e.charAt(u),$.test(d)?u++:(d=n,_===0&&y(je));else h=n;return h!==n?l=e.substring(l,u):l=h,_--,l===n&&(h=n,_===0&&y(Dn)),l}function Ei(){var l,h,d;for(_++,l=u,h=[],d=e.charAt(u),te.test(d)?u++:(d=n,_===0&&y(Et));d!==n;)h.push(d),d=e.charAt(u),te.test(d)?u++:(d=n,_===0&&y(Et));return l=e.substring(l,u),_--,h=n,_===0&&y(Ln),l}function Pi(){var l,h,d;return l=u,h=qt(),F(),d=Ni(),d===n&&(d=null),F(),l=di(h,d),l}function qt(){var l,h,d,C;for(l=u,h=Qe(),h===n&&(h=null),d=[],C=Dt();C!==n;)d.push(C),C=Dt();return l=pi(h,d),l}function Dt(){var l,h,d,C,S,P,fe,Oe;if(l=u,F(),Ai(),F(),h=$i(),h!==n){for(d=Mi(),d===n&&(d=null),C=[],S=Lt();S!==n;)C.push(S),S=Lt();for(S=F(),P=Qe(),P===n&&(P=null),fe=[],Oe=Rt();Oe!==n;)fe.push(Oe),Oe=Rt();l=gi(h,d,C,P,fe)}else u=l,l=n;return l}function Ai(){var l,h,d,C,S,P;for(_++,l=u,h=[],d=e.charAt(u),R.test(d)?u++:(d=n,_===0&&y(Te));d!==n;)h.push(d),d=e.charAt(u),R.test(d)?u++:(d=n,_===0&&y(Te));if(e.charCodeAt(u)===46?(d=c,u++):(d=n,_===0&&y(Fn)),d!==n){for(C=F(),S=[],P=e.charAt(u),j.test(P)?u++:(P=n,_===0&&y(Pt));P!==n;)S.push(P),P=e.charAt(u),j.test(P)?u++:(P=n,_===0&&y(Pt));h=[h,d,C,S],l=h}else u=l,l=n;return _--,l===n&&(h=n,_===0&&y(Rn)),l}function $i(){var l,h,d,C,S,P;if(_++,l=u,h=u,e.substr(u,5)===p?(d=p,u+=5):(d=n,_===0&&y(Un)),d===n&&(e.substr(u,3)===g?(d=g,u+=3):(d=n,_===0&&y(Hn)),d===n&&(e.substr(u,5)===m?(d=m,u+=5):(d=n,_===0&&y(Wn)),d===n&&(e.substr(u,3)===v?(d=v,u+=3):(d=n,_===0&&y(jn)),d===n))))if(d=u,C=e.charAt(u),$.test(C)?u++:(C=n,_===0&&y(je)),C!==n){if(S=[],P=e.charAt(u),ce.test(P)?u++:(P=n,_===0&&y(At)),P!==n)for(;P!==n;)S.push(P),P=e.charAt(u),ce.test(P)?u++:(P=n,_===0&&y(At));else S=n;S!==n?(C=[C,S],d=C):(u=d,d=n)}else u=d,d=n;return d!==n?(C=e.charAt(u),On.test(C)?u++:(C=n,_===0&&y(Qn)),C===n&&(C=null),d=[d,C],h=d):(u=h,h=n),h!==n?l=e.substring(l,u):l=h,_--,l===n&&(h=n,_===0&&y(Bn)),l}function Mi(){var l,h,d;for(_++,l=u,h=[],d=e.charAt(u),wt.test(d)?u++:(d=n,_===0&&y($t));d!==n;)h.push(d),h.length>=2?d=n:(d=e.charAt(u),wt.test(d)?u++:(d=n,_===0&&y($t)));return h.length<1?(u=l,l=n):l=h,_--,l===n&&(h=n,_===0&&y(zn)),l}function Lt(){var l,h,d,C,S;if(_++,l=u,F(),e.charCodeAt(u)===36?(h=b,u++):(h=n,_===0&&y(Gn)),h!==n){if(d=u,C=[],S=e.charAt(u),R.test(S)?u++:(S=n,_===0&&y(Te)),S!==n)for(;S!==n;)C.push(S),S=e.charAt(u),R.test(S)?u++:(S=n,_===0&&y(Te));else C=n;C!==n?d=e.substring(d,u):d=C,d!==n?l=mi(d):(u=l,l=n)}else u=l,l=n;return _--,l===n&&_===0&&y(Vn),l}function Qe(){var l;return l=xi(),l===n&&(l=Ti()),l}function xi(){var l,h,d,C,S;if(_++,l=u,e.charCodeAt(u)===123?(h=w,u++):(h=n,_===0&&y(Yn)),h!==n){for(d=u,C=[],S=e.charAt(u),yt.test(S)?u++:(S=n,_===0&&y(Mt));S!==n;)C.push(S),S=e.charAt(u),yt.test(S)?u++:(S=n,_===0&&y(Mt));d=e.substring(d,u),e.charCodeAt(u)===125?(C=A,u++):(C=n,_===0&&y(Xn)),C!==n?l=vi(d):(u=l,l=n)}else u=l,l=n;return _--,l===n&&(h=n,_===0&&y(Zn)),l}function Ti(){var l,h,d,C,S;if(_++,l=u,e.charCodeAt(u)===59?(h=x,u++):(h=n,_===0&&y(ei)),h!==n){for(d=u,C=[],S=e.charAt(u),Ct.test(S)?u++:(S=n,_===0&&y(xt));S!==n;)C.push(S),S=e.charAt(u),Ct.test(S)?u++:(S=n,_===0&&y(xt));d=e.substring(d,u),l=_i(d)}else u=l,l=n;return _--,l===n&&(h=n,_===0&&y(Jn)),l}function Rt(){var l,h,d,C;return _++,l=u,F(),e.charCodeAt(u)===40?(h=T,u++):(h=n,_===0&&y(ni)),h!==n?(d=qt(),d!==n?(F(),e.charCodeAt(u)===41?(C=le,u++):(C=n,_===0&&y(ii)),C!==n?l=bi(d):(u=l,l=n)):(u=l,l=n)):(u=l,l=n),_--,l===n&&_===0&&y(ti),l}function Ni(){var l,h,d;return _++,l=u,e.substr(u,3)===_e?(h=_e,u+=3):(h=n,_===0&&y(oi)),h===n&&(e.substr(u,3)===W?(h=W,u+=3):(h=n,_===0&&y(si)),h===n&&(e.substr(u,7)===be?(h=be,u+=7):(h=n,_===0&&y(ai)),h===n&&(e.charCodeAt(u)===42?(h=we,u++):(h=n,_===0&&y(li))))),h!==n?(F(),d=Qe(),d===n&&(d=null),l=wi(h,d)):(u=l,l=n),_--,l===n&&(h=n,_===0&&y(ri)),l}function F(){var l,h;for(_++,l=[],h=e.charAt(u),St.test(h)?u++:(h=n,_===0&&y(Tt));h!==n;)l.push(h),h=e.charAt(u),St.test(h)?u++:(h=n,_===0&&y(Tt));return _--,h=n,_===0&&y(ci),l}if(Se=o(),t.peg$library)return{peg$result:Se,peg$currPos:u,peg$FAILED:n,peg$maxFailExpected:Ne,peg$maxFailPos:Z};if(Se!==n&&u===e.length)return Se;throw Se!==n&&u<e.length&&y(yi()),Ci(Ne,Z<e.length?e.charAt(Z):null,Z<e.length?Ot(Z,Z+1):Ot(Z,Z))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const qe=0xffffffffffffffffn;function Ge(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function Bt(e,t){return e*t&qe}function Hi(e){return function(){let t=BigInt(e&qe),n=BigInt(e>>64n&qe);const i=Bt(Ge(Bt(t,5n),7n),9n);return n^=t,t=(Ge(t,24n)^n^n<<16n)&qe,n=Ge(n,37n),e=n<<64n|t,i}}const We=Hi(0xa187eb39cdcaed8f31c4b365b102e01en),Wi=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>We()))),ji=Array.from({length:8},()=>We()),Qi=Array.from({length:16},()=>We()),Ze=We(),L="w",Q="b",N="p",ot="n",De="b",Ae="r",oe="q",O="k",Ye="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class Ke{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,n){const{color:i,piece:r,from:o,to:s,flags:a,captured:f,promotion:c}=n,p=q(o),g=q(s);this.color=i,this.piece=r,this.from=p,this.to=g,this.san=t._moveToSan(n,t._moves({legal:!0})),this.lan=p+g,this.before=t.fen(),t._makeMove(n),this.after=t.fen(),t._undoMove(),this.flags="";for(const m in E)E[m]&a&&(this.flags+=he[m]);f&&(this.captured=f),c&&(this.promotion=c,this.lan+=c)}isCapture(){return this.flags.indexOf(he.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(he.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(he.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(he.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(he.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(he.BIG_PAWN)>-1}}const D=-1,he={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},E={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},st={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},zi={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Vi={...st,...zi},k={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Xe={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ut={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Gi=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Zi=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Yi={p:1,n:2,b:4,r:8,q:16,k:32},Xi="pnbrqkPNBRQK",Ht=[ot,De,Ae,oe],Ji=7,er=6,tr=1,nr=0,Ie={[O]:E.KSIDE_CASTLE,[oe]:E.QSIDE_CASTLE},ne={w:[{square:k.a1,flag:E.QSIDE_CASTLE},{square:k.h1,flag:E.KSIDE_CASTLE}],b:[{square:k.a8,flag:E.QSIDE_CASTLE},{square:k.h8,flag:E.KSIDE_CASTLE}]},ir={b:tr,w:er},Je="--";function pe(e){return e>>4}function $e(e){return e&15}function tn(e){return"0123456789".indexOf(e)!==-1}function q(e){const t=$e(e),n=pe(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function ke(e){return e===L?Q:L}function rr(e){const t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const n=parseInt(t[5],10);if(isNaN(n)||n<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const i=parseInt(t[4],10);if(isNaN(i)||i<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const r=t[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<r.length;s++){let a=0,f=!1;for(let c=0;c<r[s].length;c++)if(tn(r[s][c])){if(f)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(r[s][c],10),f=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[s][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,f=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:s,regex:a}of o){if(!a.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(r[0]+r[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function or(e,t){const n=e.from,i=e.to,r=e.piece;let o=0,s=0,a=0;for(let f=0,c=t.length;f<c;f++){const p=t[f].from,g=t[f].to,m=t[f].piece;r===m&&n!==p&&i===g&&(o++,pe(n)===pe(p)&&s++,$e(n)===$e(p)&&a++)}return o>0?s>0&&a>0?q(n):a>0?q(n).charAt(1):q(n).charAt(0):""}function ie(e,t,n,i,r,o=void 0,s=E.NORMAL){const a=pe(i);if(r===N&&(a===Ji||a===nr))for(let f=0;f<Ht.length;f++){const c=Ht[f];e.push({color:t,from:n,to:i,piece:r,captured:o,promotion:c,flags:s|E.PROMOTION})}else e.push({color:t,from:n,to:i,piece:r,captured:o,flags:s})}function Wt(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:N:(t=t.toLowerCase(),t==="o"?O:t)}function et(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class sr{_board=new Array(128);_turn=L;_header={};_kings={w:D,b:D};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=Ye,{skipValidation:n=!1}={}){this.load(t,{skipValidation:n})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:D,b:D},this._turn=L,this._castling={w:0,b:0},this._epSquare=D,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Vi},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:n=!1,preserveHeaders:i=!1}={}){let r=t.split(/\s+/);if(r.length>=2&&r.length<6){const a=["-","-","0","1"];t=r.concat(a.slice(-(6-r.length))).join(" ")}if(r=t.split(/\s+/),!n){const{ok:a,error:f}=rr(t);if(!a)throw new Error(f)}const o=r[0];let s=0;this.clear({preserveHeaders:i});for(let a=0;a<o.length;a++){const f=o.charAt(a);if(f==="/")s+=8;else if(tn(f))s+=parseInt(f,10);else{const c=f<"a"?L:Q;this._put({type:f.toLowerCase(),color:c},q(s)),s++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=E.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=E.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=E.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=E.QSIDE_CASTLE),this._epSquare=r[3]==="-"?D:k[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let n=0,i="";for(let s=k.a8;s<=k.h1;s++){if(this._board[s]){n>0&&(i+=n,n=0);const{color:a,type:f}=this._board[s];i+=a===L?f.toUpperCase():f.toLowerCase()}else n++;s+1&136&&(n>0&&(i+=n),s!==k.h1&&(i+="/"),n=0,s+=8)}let r="";this._castling[L]&E.KSIDE_CASTLE&&(r+="K"),this._castling[L]&E.QSIDE_CASTLE&&(r+="Q"),this._castling[Q]&E.KSIDE_CASTLE&&(r+="k"),this._castling[Q]&E.QSIDE_CASTLE&&(r+="q"),r=r||"-";let o="-";if(this._epSquare!==D)if(t)o=q(this._epSquare);else{const s=this._epSquare+(this._turn===L?16:-16),a=[s+1,s-1];for(const f of a){if(f&136)continue;const c=this._turn;if(this._board[f]?.color===c&&this._board[f]?.type===N){this._makeMove({color:c,from:f,to:this._epSquare,piece:N,captured:N,flags:E.EP_CAPTURE});const p=!this._isKingAttacked(c);if(this._undoMove(),p){o=q(this._epSquare);break}}}}return[i,this._turn,r,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:n,type:i}=this._board[t],r={w:0,b:1}[n],o={p:0,n:1,b:2,r:3,q:4,k:5}[i];return Wi[r][o][t]}_epKey(){return this._epSquare===D?0n:ji[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return Qi[t]}_computeHash(){let t=0n;for(let n=k.a8;n<=k.h1;n++){if(n&136){n+=7;continue}this._board[n]&&(t^=this._pieceKey(n))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Ze),t}_updateSetup(t){this._history.length>0||(t!==Ye?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Ye)}get(t){return this._board[k[t]]}findPiece(t){const n=[];for(let i=k.a8;i<=k.h1;i++){if(i&136){i+=7;continue}!this._board[i]||this._board[i]?.color!==t.color||this._board[i].color===t.color&&this._board[i].type===t.type&&n.push(q(i))}return n}put({type:t,color:n},i){return this._put({type:t,color:n},i)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,n){this._hash^=this._pieceKey(t),this._board[t]=n,this._hash^=this._pieceKey(t)}_put({type:t,color:n},i){if(Xi.indexOf(t.toLowerCase())===-1||!(i in k))return!1;const r=k[i];if(t==O&&!(this._kings[n]==D||this._kings[n]==r))return!1;const o=this._board[r];return o&&o.type===O&&(this._kings[o.color]=D),this._set(r,{type:t,color:n}),t===O&&(this._kings[n]=r),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const n=this.get(t);return this._clear(k[t]),n&&n.type===O&&(this._kings[n.color]=D),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),n}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[k.e1]?.type===O&&this._board[k.e1]?.color===L,n=this._board[k.e8]?.type===O&&this._board[k.e8]?.color===Q;(!t||this._board[k.a1]?.type!==Ae||this._board[k.a1]?.color!==L)&&(this._castling.w&=-65),(!t||this._board[k.h1]?.type!==Ae||this._board[k.h1]?.color!==L)&&(this._castling.w&=-33),(!n||this._board[k.a8]?.type!==Ae||this._board[k.a8]?.color!==Q)&&(this._castling.b&=-65),(!n||this._board[k.h8]?.type!==Ae||this._board[k.h8]?.color!==Q)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===D)return;const t=this._epSquare+(this._turn===L?-16:16),n=this._epSquare+(this._turn===L?16:-16),i=[n+1,n-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[n]?.color!==ke(this._turn)||this._board[n]?.type!==N){this._hash^=this._epKey(),this._epSquare=D;return}const r=o=>!(o&136)&&this._board[o]?.color===this._turn&&this._board[o]?.type===N;i.some(r)||(this._hash^=this._epKey(),this._epSquare=D)}_attacked(t,n,i){const r=[];for(let o=k.a8;o<=k.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const s=this._board[o],a=o-n;if(a===0)continue;const f=a+119;if(Gi[f]&Yi[s.type]){if(s.type===N){if(a>0&&s.color===L||a<=0&&s.color===Q)if(i)r.push(q(o));else return!0;continue}if(s.type==="n"||s.type==="k")if(i){r.push(q(o));continue}else return!0;const c=Zi[f];let p=o+c,g=!1;for(;p!==n;){if(this._board[p]!=null){g=!0;break}p+=c}if(!g)if(i){r.push(q(o));continue}else return!0}}return i?r:!1}attackers(t,n){return n?this._attacked(n,k[t],!0):this._attacked(this._turn,k[t],!0)}_isKingAttacked(t){const n=this._kings[t];return n===-1?!1:this._attacked(ke(t),n)}hash(){return this._hash.toString(16)}isAttacked(t,n){return this._attacked(n,k[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},n=[];let i=0,r=0;for(let o=k.a8;o<=k.h1;o++){if(r=(r+1)%2,o&136){o+=7;continue}const s=this._board[o];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===De&&n.push(r),i++)}if(i===2)return!0;if(i===3&&(t[De]===1||t[ot]===1))return!0;if(i===t[De]+2){let o=0;const s=n.length;for(let a=0;a<s;a++)o+=n[a];if(o===0||o===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:n=void 0,piece:i=void 0}={}){const r=this._moves({square:n,piece:i});return t?r.map(o=>new Ke(this,o)):r.map(o=>this._moveToSan(o,r))}_moves({legal:t=!0,piece:n=void 0,square:i=void 0}={}){const r=i?i.toLowerCase():void 0,o=n?.toLowerCase(),s=[],a=this._turn,f=ke(a);let c=k.a8,p=k.h1,g=!1;if(r)if(r in k)c=p=k[r],g=!0;else return[];for(let v=c;v<=p;v++){if(v&136){v+=7;continue}if(!this._board[v]||this._board[v].color===f)continue;const{type:b}=this._board[v];let w;if(b===N){if(o&&o!==b)continue;w=v+Xe[a][0],this._board[w]||(ie(s,a,v,w,N),w=v+Xe[a][1],ir[a]===pe(v)&&!this._board[w]&&ie(s,a,v,w,N,void 0,E.BIG_PAWN));for(let A=2;A<4;A++)w=v+Xe[a][A],!(w&136)&&(this._board[w]?.color===f?ie(s,a,v,w,N,this._board[w].type,E.CAPTURE):w===this._epSquare&&ie(s,a,v,w,N,N,E.EP_CAPTURE))}else{if(o&&o!==b)continue;for(let A=0,x=Ut[b].length;A<x;A++){const T=Ut[b][A];for(w=v;w+=T,!(w&136);){if(!this._board[w])ie(s,a,v,w,b);else{if(this._board[w].color===a)break;ie(s,a,v,w,b,this._board[w].type,E.CAPTURE);break}if(b===ot||b===O)break}}}}if((o===void 0||o===O)&&(!g||p===this._kings[a])){if(this._castling[a]&E.KSIDE_CASTLE){const v=this._kings[a],b=v+2;!this._board[v+1]&&!this._board[b]&&!this._attacked(f,this._kings[a])&&!this._attacked(f,v+1)&&!this._attacked(f,b)&&ie(s,a,this._kings[a],b,O,void 0,E.KSIDE_CASTLE)}if(this._castling[a]&E.QSIDE_CASTLE){const v=this._kings[a],b=v-2;!this._board[v-1]&&!this._board[v-2]&&!this._board[v-3]&&!this._attacked(f,this._kings[a])&&!this._attacked(f,v-1)&&!this._attacked(f,b)&&ie(s,a,this._kings[a],b,O,void 0,E.QSIDE_CASTLE)}}if(!t||this._kings[a]===-1)return s;const m=[];for(let v=0,b=s.length;v<b;v++)this._makeMove(s[v]),this._isKingAttacked(a)||m.push(s[v]),this._undoMove();return m}move(t,{strict:n=!1}={}){let i=null;if(typeof t=="string")i=this._moveFromSan(t,n);else if(t===null)i=this._moveFromSan(Je,n);else if(typeof t=="object"){const o=this._moves();for(let s=0,a=o.length;s<a;s++)if(t.from===q(o[s].from)&&t.to===q(o[s].to)&&(!("promotion"in o[s])||t.promotion===o[s].promotion)){i=o[s];break}}if(!i)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&i.flags&E.NULL_MOVE)throw new Error("Null move not allowed when in check");const r=new Ke(this,i);return this._makeMove(i),this._incPositionCount(),r}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,n){this._hash^=this._pieceKey(t),this._board[n]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(n)}_makeMove(t){const n=this._turn,i=ke(n);if(this._push(t),t.flags&E.NULL_MOVE){n===Q&&this._moveNumber++,this._halfMoves++,this._turn=i,this._epSquare=D;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&E.EP_CAPTURE&&(this._turn===Q?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:n})),this._board[t.to].type===O){if(this._kings[n]=t.to,t.flags&E.KSIDE_CASTLE){const r=t.to-1,o=t.to+1;this._movePiece(o,r)}else if(t.flags&E.QSIDE_CASTLE){const r=t.to+1,o=t.to-2;this._movePiece(o,r)}this._castling[n]=0}if(this._castling[n]){for(let r=0,o=ne[n].length;r<o;r++)if(t.from===ne[n][r].square&&this._castling[n]&ne[n][r].flag){this._castling[n]^=ne[n][r].flag;break}}if(this._castling[i]){for(let r=0,o=ne[i].length;r<o;r++)if(t.to===ne[i][r].square&&this._castling[i]&ne[i][r].flag){this._castling[i]^=ne[i][r].flag;break}}if(this._hash^=this._castlingKey(),t.flags&E.BIG_PAWN){let r;n===Q?r=t.to-16:r=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===N&&this._board[t.to-1]?.color===i||!(t.to+1&136)&&this._board[t.to+1]?.type===N&&this._board[t.to+1]?.color===i?(this._epSquare=r,this._hash^=this._epKey()):this._epSquare=D}else this._epSquare=D;t.piece===N?this._halfMoves=0:t.flags&(E.CAPTURE|E.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,n===Q&&this._moveNumber++,this._turn=i,this._hash^=Ze}undo(){const t=this._hash,n=this._undoMove();if(n){const i=new Ke(this,n);return this._decPositionCount(t),i}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const n=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Ze;const i=this._turn,r=ke(i);if(n.flags&E.NULL_MOVE)return n;if(this._movePiece(n.to,n.from),n.piece&&(this._clear(n.from),this._set(n.from,{type:n.piece,color:i})),n.captured)if(n.flags&E.EP_CAPTURE){let o;i===Q?o=n.to-16:o=n.to+16,this._set(o,{type:N,color:r})}else this._set(n.to,{type:n.captured,color:r});if(n.flags&(E.KSIDE_CASTLE|E.QSIDE_CASTLE)){let o,s;n.flags&E.KSIDE_CASTLE?(o=n.to+1,s=n.to-1):(o=n.to-2,s=n.to+1),this._movePiece(s,o)}return n}pgn({newline:t=`
`,maxWidth:n=0}={}){const i=[];let r=!1;for(const m in this._header)this._header[m]&&i.push(`[${m} "${this._header[m]}"]`+t),r=!0;r&&this._history.length&&i.push(t);const o=m=>{const v=this._comments[this.fen()];if(typeof v<"u"){const b=m.length>0?" ":"";m=`${m}${b}{${v}}`}return m},s=[];for(;this._history.length>0;)s.push(this._undoMove());const a=[];let f="";for(s.length===0&&a.push(o(""));s.length>0;){f=o(f);const m=s.pop();if(!m)break;if(!this._history.length&&m.color==="b"){const v=`${this._moveNumber}. ...`;f=f?`${f} ${v}`:v}else m.color==="w"&&(f.length&&a.push(f),f=this._moveNumber+".");f=f+" "+this._moveToSan(m,this._moves({legal:!0})),this._makeMove(m)}if(f.length&&a.push(o(f)),a.push(this._header.Result||"*"),n===0)return i.join("")+a.join(" ");const c=function(){return i.length>0&&i[i.length-1]===" "?(i.pop(),!0):!1},p=function(m,v){for(const b of v.split(" "))if(b){if(m+b.length>n){for(;c();)m--;i.push(t),m=0}i.push(b),m+=b.length,i.push(" "),m++}return c()&&m--,m};let g=0;for(let m=0;m<a.length;m++){if(g+a[m].length>n&&a[m].includes("{")){g=p(g,a[m]);continue}g+a[m].length>n&&m!==0?(i[i.length-1]===" "&&i.pop(),i.push(t),g=0):m!==0&&(i.push(" "),g++),i.push(a[m]),g+=a[m].length}return i.join("")}header(...t){for(let n=0;n<t.length;n+=2)typeof t[n]=="string"&&typeof t[n+1]=="string"&&(this._header[t[n]]=t[n+1]);return this._header}setHeader(t,n){return this._header[t]=n??st[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=st[t]||null,!0):!1}getHeaders(){const t={};for(const[n,i]of Object.entries(this._header))i!==null&&(t[n]=i);return t}loadPgn(t,{strict:n=!1,newlineChar:i=`\r?
`}={}){i!==`\r?
`&&(t=t.replace(new RegExp(i,"g"),`
`));const r=Ui(t);this.reset();const o=r.headers;let s="";for(const c in o)c.toLowerCase()==="fen"&&(s=o[c]),this.header(c,o[c]);if(!n)s&&this.load(s,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let a=r.root;for(;a;){if(a.move){const c=this._moveFromSan(a.move,n);if(c==null)throw new Error(`Invalid move in PGN: ${a.move}`);this._makeMove(c),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}const f=r.result;f&&Object.keys(this._header).length&&this._header.Result!==f&&this.setHeader("Result",f)}_moveToSan(t,n){let i="";if(t.flags&E.KSIDE_CASTLE)i="O-O";else if(t.flags&E.QSIDE_CASTLE)i="O-O-O";else{if(t.flags&E.NULL_MOVE)return Je;if(t.piece!==N){const r=or(t,n);i+=t.piece.toUpperCase()+r}t.flags&(E.CAPTURE|E.EP_CAPTURE)&&(t.piece===N&&(i+=q(t.from)[0]),i+="x"),i+=q(t.to),t.promotion&&(i+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(t,n=!1){let i=et(t);if(n||(i==="0-0"?i="O-O":i==="0-0-0"&&(i="O-O-O")),i==Je)return{color:this._turn,from:0,to:0,piece:"k",flags:E.NULL_MOVE};let r=Wt(i),o=this._moves({legal:!0,piece:r});for(let m=0,v=o.length;m<v;m++)if(i===et(this._moveToSan(o[m],o)))return o[m];if(n)return null;let s,a,f,c,p,g=!1;if(a=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],f=a[2],c=a[3],p=a[4],f.length==1&&(g=!0)):(a=i.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],f=a[2],c=a[3],p=a[4],f.length==1&&(g=!0))),r=Wt(i),o=this._moves({legal:!0,piece:s||r}),!c)return null;for(let m=0,v=o.length;m<v;m++)if(f){if((!s||s.toLowerCase()==o[m].piece)&&k[f]==o[m].from&&k[c]==o[m].to&&(!p||p.toLowerCase()==o[m].promotion))return o[m];if(g){const b=q(o[m].from);if((!s||s.toLowerCase()==o[m].piece)&&k[c]==o[m].to&&(f==b[0]||f==b[1])&&(!p||p.toLowerCase()==o[m].promotion))return o[m]}}else if(i===et(this._moveToSan(o[m],o)).replace("x",""))return o[m];return null}ascii(){let t=`   +------------------------+
`;for(let n=k.a8;n<=k.h1;n++){if($e(n)===0&&(t+=" "+"87654321"[pe(n)]+" |"),this._board[n]){const i=this._board[n].type,o=this._board[n].color===L?i.toUpperCase():i.toLowerCase();t+=" "+o+" "}else t+=" . ";n+1&136&&(t+=`|
`,n+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const n=this._moves({legal:!1});let i=0;const r=this._turn;for(let o=0,s=n.length;o<s;o++)this._makeMove(n[o]),this._isKingAttacked(r)||(t-1>0?i+=this.perft(t-1):i++),this._undoMove();return i}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let n=[];for(let i=k.a8;i<=k.h1;i++)this._board[i]==null?n.push(null):n.push({square:q(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(t.push(n),n=[],i+=8);return t}squareColor(t){if(t in k){const n=k[t];return(pe(n)+$e(n))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const n=[],i=[];for(;this._history.length>0;)n.push(this._undoMove());for(;;){const r=n.pop();if(!r)break;t?i.push(new Ke(this,r)):i.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return i}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const n=this._positionCount.get(t)??0;n===1?this._positionCount.delete(t):this._positionCount.set(t,n-1)}_pruneComments(){const t=[],n={},i=r=>{r in this._comments&&(n[r]=this._comments[r])};for(;this._history.length>0;)t.push(this._undoMove());for(i(this.fen());;){const r=t.pop();if(!r)break;this._makeMove(r),i(this.fen())}this._comments=n}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const n=this._comments[t];return delete this._comments[t],{fen:t,comment:n}})}setCastlingRights(t,n){for(const r of[O,oe])n[r]!==void 0&&(n[r]?this._castling[t]|=Ie[r]:this._castling[t]&=~Ie[r]);this._updateCastlingRights();const i=this.getCastlingRights(t);return(n[O]===void 0||n[O]===i[O])&&(n[oe]===void 0||n[oe]===i[oe])}getCastlingRights(t){return{[O]:(this._castling[t]&Ie[O])!==0,[oe]:(this._castling[t]&Ie[oe])!==0}}moveNumber(){return this._moveNumber}}const ar=["white","black"],Le=["a","b","c","d","e","f","g","h"],Re=["1","2","3","4","5","6","7","8"],lr=[...Re].reverse(),ut=Array.prototype.concat(...Le.map(e=>Re.map(t=>e+t))),V=e=>ut[8*e[0]+e[1]],M=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],nn=ut.map(M);function cr(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const fr=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},ht=e=>e==="white"?"black":"white",Me=(e,t)=>{const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i},at=(e,t)=>e.role===t.role&&e.color===t.color,xe=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],X=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},rn=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},dt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},me=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},on=e=>e.button===2,ee=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function sn(e,t,n){const i=M(e);return t||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const ge=(e,t)=>Math.abs(e-t),ur=e=>(t,n,i,r)=>ge(t,i)<2&&(e==="white"?r===n+1||n<=1&&r===n+2&&t===i:r===n-1||n>=6&&r===n-2&&t===i),an=(e,t,n,i)=>{const r=ge(e,n),o=ge(t,i);return r===1&&o===2||r===2&&o===1},ln=(e,t,n,i)=>ge(e,n)===ge(t,i),cn=(e,t,n,i)=>e===n||t===i,fn=(e,t,n,i)=>ln(e,t,n,i)||cn(e,t,n,i),hr=(e,t,n)=>(i,r,o,s)=>ge(i,o)<2&&ge(r,s)<2||n&&r===s&&r===(e==="white"?0:7)&&(i===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function dr(e,t){const n=t==="white"?"1":"8",i=[];for(const[r,o]of e)r[1]===n&&o.color===t&&o.role==="rook"&&i.push(M(r)[0]);return i}function un(e,t,n){const i=e.get(t);if(!i)return[];const r=M(t),o=i.role,s=o==="pawn"?ur(i.color):o==="knight"?an:o==="bishop"?ln:o==="rook"?cn:o==="queen"?fn:hr(i.color,dr(e,i.color),n);return nn.filter(a=>(r[0]!==a[0]||r[1]!==a[1])&&s(r[0],r[1],a[0],a[1])).map(V)}function U(e,...t){e&&setTimeout(()=>e(...t),1)}function pr(e){e.orientation=ht(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function gr(e,t){for(const[n,i]of t)i?e.pieces.set(n,i):e.pieces.delete(n)}function mr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,i]of e.pieces)i.role==="king"&&i.color===t&&(e.check=n)}function vr(e,t,n,i){ae(e),e.premovable.current=[t,n],U(e.premovable.events.set,t,n,i)}function se(e){e.premovable.current&&(e.premovable.current=void 0,U(e.premovable.events.unset))}function _r(e,t,n){se(e),e.predroppable.current={role:t,key:n},U(e.predroppable.events.set,t,n)}function ae(e){const t=e.predroppable;t.current&&(t.current=void 0,U(t.events.unset))}function br(e,t,n){if(!e.autoCastle)return!1;const i=e.pieces.get(t);if(!i||i.role!=="king")return!1;const r=M(t),o=M(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=V([7,o[1]]):o[0]===2&&(n=V([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(V([6,o[1]]),i),e.pieces.set(V([5,o[1]]),s)):(e.pieces.set(V([2,o[1]]),i),e.pieces.set(V([3,o[1]]),s)),!0)}function hn(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===e.selected&&G(e),U(e.events.move,t,n,o),br(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,U(e.events.change),o||!0}function pt(e,t,n,i){if(e.pieces.has(n))if(i)e.pieces.delete(n);else return!1;return U(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,U(e.events.change),e.movable.dests=void 0,e.turnColor=ht(e.turnColor),!0}function dn(e,t,n){const i=hn(e,t,n);return i&&(e.movable.dests=void 0,e.turnColor=ht(e.turnColor),e.animation.current=void 0),i}function pn(e,t,n){if(gt(e,t,n)){const i=dn(e,t,n);if(i){const r=e.hold.stop();G(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),U(e.movable.events.after,t,n,o),!0}}else if(yr(e,t,n))return vr(e,t,n,{ctrlKey:e.stats.ctrlKey}),G(e),!0;return G(e),!1}function gn(e,t,n,i){const r=e.pieces.get(t);r&&(wr(e,t,n)||i)?(e.pieces.delete(t),pt(e,r,n,i),U(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&Cr(e,t,n)?_r(e,r.role,n):(se(e),ae(e)),e.pieces.delete(t),G(e)}function lt(e,t,n){if(U(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){G(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&pn(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(vn(e,t)||mt(e,t))&&(mn(e,t),e.hold.start())}function mn(e,t){e.selected=t,mt(e,t)?e.premovable.customDests||(e.premovable.dests=un(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function G(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function vn(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const gt=(e,t,n)=>{var i,r;return t!==n&&vn(e,t)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(t))===null||r===void 0)&&r.includes(n)))};function wr(e,t,n){const i=e.pieces.get(t);return!!i&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function mt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function yr(e,t,n){var i,r;const o=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(t))!==null&&r!==void 0?r:un(e.pieces,t,e.premovable.castle);return t!==n&&mt(e,t)&&o.includes(n)}function Cr(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function Sr(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function kr(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],i=t[1];let r=!1;if(gt(e,n,i)){const o=dn(e,n,i);if(o){const s={premove:!0};o!==!0&&(s.captured=o),U(e.movable.events.after,n,i,s),r=!0}}return se(e),r}function Er(e,t){const n=e.predroppable.current;let i=!1;if(!n)return!1;if(t(n)){const r={role:n.role,color:e.movable.color};pt(e,r,n.key)&&(U(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return ae(e),i}function vt(e){se(e),ae(e),G(e)}function jt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,vt(e)}function ve(e,t,n){let i=Math.floor(8*(e[0]-n.left)/n.width);t||(i=7-i);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),i>=0&&i<8&&r>=0&&r<8?V([i,r]):void 0}function Pr(e,t,n,i){const r=M(e),o=nn.filter(c=>fn(r[0],r[1],c[0],c[1])||an(r[0],r[1],c[0],c[1])),a=o.map(c=>sn(V(c),n,i)).map(c=>Me(t,c)),[,f]=a.reduce((c,p,g)=>c[0]<p?c:[p,g],[a[0],0]);return V(o[f])}const H=e=>e.orientation==="white",_n="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ar={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},$r={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function bn(e){e==="start"&&(e=_n);const t=new Map;let n=7,i=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;i=0;break;case"~":{const o=t.get(V([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const s=r.toLowerCase();t.set(V([i,n]),{role:Ar[s],color:r===s?"black":"white"}),++i}}}return t}function Mr(e){return lr.map(t=>Le.map(n=>{const i=e.get(n+t);if(i){let r=$r[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function wn(e,t){t.animation&&(_t(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function yn(e,t){var n,i,r;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((i=t.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),_t(e,t),t.fen&&(e.pieces=bn(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&mr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&mn(e,e.selected),wn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,a=e.movable.dests.get(s),f=e.pieces.get(s);if(!a||!f||f.role!=="king")return;e.movable.dests.set(s,a.filter(c=>!(c==="a"+o&&a.includes("c"+o))&&!(c==="h"+o&&a.includes("g"+o))))}}function _t(e,t){for(const n in t)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(t,n)||(Object.prototype.hasOwnProperty.call(e,n)&&Qt(e[n])&&Qt(t[n])?_t(e[n],t[n]):e[n]=t[n])}function Qt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const de=(e,t)=>t.animation.enabled?Nr(e,t):re(e,t);function re(e,t){const n=e(t);return t.dom.redraw(),n}const tt=(e,t)=>({key:e,pos:M(e),piece:t}),xr=(e,t)=>t.sort((n,i)=>Me(e.pos,n.pos)-Me(e.pos,i.pos))[0];function Tr(e,t){const n=new Map,i=[],r=new Map,o=[],s=[],a=new Map;let f,c,p;for(const[g,m]of e)a.set(g,tt(g,m));for(const g of ut)f=t.pieces.get(g),c=a.get(g),f?c?at(f,c.piece)||(o.push(c),s.push(tt(g,f))):s.push(tt(g,f)):c&&o.push(c);for(const g of s)c=xr(g,o.filter(m=>at(g.piece,m.piece))),c&&(p=[c.pos[0]-g.pos[0],c.pos[1]-g.pos[1]],n.set(g.key,p.concat(p)),i.push(c.key));for(const g of o)i.includes(g.key)||r.set(g.key,g.piece);return{anims:n,fadings:r}}function Cn(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(t-n.start)*n.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=Or(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>Cn(e,o))}}function Nr(e,t){const n=new Map(t.pieces),i=e(t),r=Tr(n,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||Cn(t,performance.now())}else t.dom.redraw();return i}const Or=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Kr=["green","red","blue","yellow"];function Ir(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?G(e):vt(e);const n=me(t),i=ve(n,H(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:Rr(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Sn(e))}function Sn(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=ve(t.pos,H(e),e.dom.bounds());n||(t.snapToValidMove=!1);const i=t.snapToValidMove?Pr(t.orig,t.pos,H(e),e.dom.bounds()):n;i!==t.mouseSq&&(t.mouseSq=i,t.dest=i!==t.orig?i:void 0,e.dom.redrawNow()),Sn(e)}})}function qr(e,t){e.drawable.current&&(e.drawable.current.pos=me(t))}function Dr(e){const t=e.drawable.current;t&&(t.mouseSq&&Fr(e.drawable,t),kn(e))}function kn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Lr(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),En(e.drawable))}function Rr(e){var t;const n=(e.shiftKey||e.ctrlKey)&&on(e),i=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Kr[(n?1:0)+(i?2:0)]}function Fr(e,t){const n=r=>r.orig===t.orig&&r.dest===t.dest,i=e.shapes.find(n);i&&(e.shapes=e.shapes.filter(r=>!n(r))),(!i||i.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),En(e)}function En(e){e.onChange&&e.onChange(e.shapes)}function Br(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),i=me(t),r=ve(i,H(e),n);if(!r)return;const o=e.pieces.get(r),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Lr(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Ur(e,i)))t.preventDefault();else if(t.touches)return;const a=!!e.premovable.current,f=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&gt(e,e.selected,r)?de(g=>lt(g,r),e):lt(e,r);const c=e.selected===r,p=An(e,r);if(o&&p&&c&&Sr(e,r)){e.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const g=e.dom.elements.ghost;g&&(g.className=`ghost ${o.color} ${o.role}`,X(g,xe(n)(M(r),H(e))),dt(g,!0)),bt(e)}else a&&se(e),f&&ae(e);e.dom.redraw()}function Ur(e,t){const n=H(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of e.pieces.keys()){const s=sn(o,n,i);if(Me(s,t)<=r)return!0}return!1}function Hr(e,t,n,i){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=me(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>An(e,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},bt(e)}function bt(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const i=e.pieces.get(n.orig);if(!i||!at(i,n.piece))Fe(e);else if(!n.started&&Me(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=e.dom.bounds();X(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==ve(n.pos,H(e),r))}bt(e)})}function Wr(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=me(t))}function jr(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}se(e),ae(e);const i=me(t)||n.pos,r=ve(i,H(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?gn(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,pn(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),U(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?G(e):e.selectable.enabled||G(e),Pn(e),e.draggable.current=void 0,e.dom.redraw()}function Fe(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,G(e),Pn(e),e.dom.redraw())}function Pn(e){const t=e.dom.elements;t.ghost&&dt(t.ghost,!1)}function An(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Qr(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{zt(e,2),setTimeout(()=>zt(e,void 0),120)},120)}function zt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function zr(e,t){function n(){pr(e),t()}return{set(i){i.orientation&&i.orientation!==e.orientation&&n(),wn(e,i),(i.fen?de:re)(r=>yn(r,i),e)},state:e,getFen:()=>Mr(e.pieces),toggleOrientation:n,setPieces(i){de(r=>gr(r,i),e)},selectSquare(i,r){i?de(o=>lt(o,i,r),e):e.selected&&(G(e),e.dom.redraw())},move(i,r){de(o=>hn(o,i,r),e)},newPiece(i,r){de(o=>pt(o,i,r),e)},playPremove(){if(e.premovable.current){if(de(kr,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=Er(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){re(se,e)},cancelPredrop(){re(ae,e)},cancelMove(){re(i=>{vt(i),Fe(i)},e)},stop(){re(i=>{jt(i),Fe(i)},e)},explode(i){Qr(e,i)},setAutoShapes(i){re(r=>r.drawable.autoShapes=i,e)},setShapes(i){re(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return ve(i,H(e),e.dom.bounds())},redrawAll:t,dragNewPiece(i,r,o){Hr(e,i,r,o)},destroy(){jt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Vr(){return{pieces:bn(_n),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:fr()}}const Vt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Gr(){const e=K("defs"),t=B(K("filter"),{id:"cg-filter-blur"});return t.appendChild(B(K("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Zr(e,t,n){var i;const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,a=new Map,f=e.dom.bounds(),c=r.autoShapes.filter(v=>!v.piece);for(const v of r.shapes.concat(c).concat(s?[s]:[])){if(!v.dest)continue;const b=(i=a.get(v.dest))!==null&&i!==void 0?i:new Set,w=He(Ue(M(v.orig),e.orientation),f),A=He(Ue(M(v.dest),e.orientation),f);b.add(ft(w,A)),a.set(v.dest,b)}const p=r.shapes.concat(c).map(v=>({shape:v,current:!1,hash:Gt(v,ct(v.dest,a),!1,f)}));s&&p.push({shape:s,current:!0,hash:Gt(s,ct(s.dest,a),!0,f)});const g=p.map(v=>v.hash).join(";");if(g===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=g;const m=t.querySelector("defs");Yr(r,p,m),Xr(p,t.querySelector("g"),n.querySelector("g"),v=>to(e,v,r.brushes,a,f))}function Yr(e,t,n){var i;const r=new Map;let o;for(const f of t.filter(c=>c.shape.dest&&c.shape.brush))o=$n(e.brushes[f.shape.brush],f.shape.modifiers),!((i=f.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(Be(o).key,Be(o)),r.set(o.key,o);const s=new Set;let a=n.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[f,c]of r.entries())s.has(f)||n.appendChild(ro(c))}function Xr(e,t,n,i){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,n]){const s=[];let a=o.firstElementChild,f;for(;a;)f=a.getAttribute("cgHash"),r.has(f)?r.set(f,!0):s.push(a),a=a.nextElementSibling;for(const c of s)o.removeChild(c)}for(const o of e.filter(s=>!r.get(s.hash)))for(const s of i(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function Gt({orig:e,dest:t,brush:n,piece:i,modifiers:r,customSvg:o,label:s},a,f,c){var p,g;return[c.width,c.height,f,e,t,n,a&&"-",i&&Jr(i),r&&eo(r),o&&`custom-${Zt(o.html)},${(g=(p=o.center)===null||p===void 0?void 0:p[0])!==null&&g!==void 0?g:"o"}`,s&&`label-${Zt(s.text)}`].filter(m=>m).join(",")}function Jr(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function eo(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Zt(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function to(e,{shape:t,current:n,hash:i},r,o,s){var a,f;const c=He(Ue(M(t.orig),e.orientation),s),p=t.dest?He(Ue(M(t.dest),e.orientation),s):c,g=t.brush&&$n(r[t.brush],t.modifiers),m=o.get(t.dest),v=[];if(g){const b=B(K("g"),{cgHash:i});v.push({el:b}),c[0]!==p[0]||c[1]!==p[1]?b.appendChild(io(t,g,c,p,n,ct(t.dest,o))):b.appendChild(no(r[t.brush],c,n,s))}if(t.label){const b=t.label;(a=b.fill)!==null&&a!==void 0||(b.fill=t.brush&&r[t.brush].color);const w=t.brush?void 0:"tr";v.push({el:oo(b,i,c,p,m,w),isCustom:!0})}if(t.customSvg){const b=(f=t.customSvg.center)!==null&&f!==void 0?f:"orig",[w,A]=b==="label"?xn(c,p,m).map(T=>T-.5):b==="dest"?p:c,x=B(K("g"),{transform:`translate(${w},${A})`,cgHash:i});x.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,v.push({el:x,isCustom:!0})}return v}function no(e,t,n,i){const r=so(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return B(K("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:Mn(e,n),cx:t[0],cy:t[1],r:o-r[1]/2})}function Be(e){return["#ffffff","#fff","white"].includes(e.color)?Vt.hilitePrimary:Vt.hiliteWhite}function io(e,t,n,i,r,o){var s;function a(p){var g;const m=lo(o&&!r),v=i[0]-n[0],b=i[1]-n[1],w=Math.atan2(b,v),A=Math.cos(w)*m,x=Math.sin(w)*m;return B(K("line"),{stroke:p?Be(t).color:t.color,"stroke-width":ao(t,r)+(p?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${p?Be(t).key:t.key})`,opacity:!((g=e.modifiers)===null||g===void 0)&&g.hilite?1:Mn(t,r),x1:n[0],y1:n[1],x2:i[0]-A,y2:i[1]-x})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);const f=K("g"),c=B(K("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(co(n,i)),c.appendChild(a(!0)),f.appendChild(c),f.appendChild(a(!1)),f}function ro(e){const t=B(K("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(B(K("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function oo(e,t,n,i,r,o){var s;const f=.4*.75**e.text.length,c=xn(n,i,r),p=o==="tr"?.4:0,g=B(K("g"),{transform:`translate(${c[0]+p},${c[1]-p})`,cgHash:t});g.appendChild(B(K("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const m=B(K("text"),{"font-size":f,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return m.innerHTML=e.text,g.appendChild(m),g}function Ue(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function ct(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function K(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function B(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function $n(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function so(){return[3/64,4/64]}function ao(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Mn(e,t){return(e.opacity||1)*(t?.9:1)}function lo(e){return(e?20:10)/64}function He(e,t){const n=Math.min(1,t.width/t.height),i=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*i]}function co(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return B(K("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function ft(e,t,n=!0){const i=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function fo(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,i)=>n+i*i,0))}function xn(e,t,n){let i=fo(e,t);const r=ft(e,t,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=ft(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(o=>o+.5)}function uo(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const f of ar)e.classList.toggle("orientation-"+f,t.orientation===f);e.classList.toggle("manipulable",!t.viewOnly);const n=ee("cg-container");e.appendChild(n);const i=ee("cg-board");n.appendChild(i);let r,o,s;if(t.drawable.visible&&(r=B(K("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(Gr()),r.appendChild(K("g")),o=B(K("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(K("g")),s=ee("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(s)),t.coordinates){const f=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const p=t.orientation==="white"?g=>g+1:g=>8-g;Le.forEach((g,m)=>n.appendChild(nt(Re.map(v=>g+v),"squares rank"+p(m)+f+c)))}else n.appendChild(nt(Re,"ranks"+f+c)),n.appendChild(nt(Le,"files"+f))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=ee("piece","ghost"),dt(a,!1),n.appendChild(a)),{board:i,container:n,wrap:e,ghost:a,svg:r,customSvg:o,autoPieces:s}}function nt(e,t){const n=ee("coords",t);let i;for(const r of e)i=ee("coord"),i.textContent=r,n.appendChild(i);return n}function ho(e,t){if(!e.dropmode.active)return;se(e),ae(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=me(t),r=i&&ve(i,H(e),e.dom.bounds());r&&gn(e,"a0",r)}e.dom.redraw()}function po(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=mo(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function go(e,t){const n=[];if("ResizeObserver"in window||n.push(Ee(document.body,"chessground.resize",t)),!e.viewOnly){const i=Yt(e,Wr,qr),r=Yt(e,jr,Dr);for(const s of["touchmove","mousemove"])n.push(Ee(document,s,i));for(const s of["touchend","mouseup"])n.push(Ee(document,s,r));const o=()=>e.dom.bounds.clear();n.push(Ee(document,"scroll",o,{capture:!0,passive:!0})),n.push(Ee(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function Ee(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}const mo=e=>t=>{e.draggable.current?Fe(e):e.drawable.current?kn(e):t.shiftKey||on(t)?e.drawable.enabled&&Ir(e,t):e.viewOnly||(e.dropmode.active?ho(e,t):Br(e,t))},Yt=(e,t,n)=>i=>{e.drawable.current?e.drawable.enabled&&n(e,i):e.viewOnly||t(e,i)};function vo(e){const t=H(e),n=xe(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,a=o?o.plan.fadings:new Map,f=e.draggable.current,c=bo(e),p=new Set,g=new Set,m=new Map,v=new Map;let b,w,A,x,T,le,_e,W,be,we;for(w=i.firstChild;w;){if(b=w.cgKey,Tn(w))if(A=r.get(b),T=s.get(b),le=a.get(b),x=w.cgPiece,w.cgDragging&&(!f||f.orig!==b)&&(w.classList.remove("dragging"),X(w,n(M(b),t)),w.cgDragging=!1),!le&&w.cgFading&&(w.cgFading=!1,w.classList.remove("fading")),A){if(T&&w.cgAnimating&&x===Pe(A)){const $=M(b);$[0]+=T[2],$[1]+=T[3],w.classList.add("anim"),X(w,n($,t))}else w.cgAnimating&&(w.cgAnimating=!1,w.classList.remove("anim"),X(w,n(M(b),t)),e.addPieceZIndex&&(w.style.zIndex=it(M(b),t)));x===Pe(A)&&(!le||!w.cgFading)?p.add(b):le&&x===Pe(le)?(w.classList.add("fading"),w.cgFading=!0):rt(m,x,w)}else rt(m,x,w);else if(Nn(w)){const $=w.className;c.get(b)===$?g.add(b):rt(v,$,w)}w=w.nextSibling}for(const[$,te]of c)if(!g.has($)){be=v.get(te),we=be&&be.pop();const R=n(M($),t);if(we)we.cgKey=$,X(we,R);else{const j=ee("square",te);j.cgKey=$,X(j,R),i.insertBefore(j,i.firstChild)}}for(const[$,te]of r)if(T=s.get($),!p.has($))if(_e=m.get(Pe(te)),W=_e&&_e.pop(),W){W.cgKey=$,W.cgFading&&(W.classList.remove("fading"),W.cgFading=!1);const R=M($);e.addPieceZIndex&&(W.style.zIndex=it(R,t)),T&&(W.cgAnimating=!0,W.classList.add("anim"),R[0]+=T[2],R[1]+=T[3]),X(W,n(R,t))}else{const R=Pe(te),j=ee("piece",R),ce=M($);j.cgPiece=R,j.cgKey=$,T&&(j.cgAnimating=!0,ce[0]+=T[2],ce[1]+=T[3]),X(j,n(ce,t)),e.addPieceZIndex&&(j.style.zIndex=it(ce,t)),i.appendChild(j)}for(const $ of m.values())Jt(e,$);for(const $ of v.values())Jt(e,$)}function _o(e){const t=H(e),n=xe(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(Tn(i)&&!i.cgAnimating||Nn(i))&&X(i,n(M(i.cgKey),t)),i=i.nextSibling}function Xt(e){var t,n;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*o;r.style.width=s+"px",r.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",a+"px")}const Tn=e=>e.tagName==="PIECE",Nn=e=>e.tagName==="SQUARE";function Jt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function it(e,t){const i=e[1];return`${t?10-i:3+i}`}const Pe=e=>`${e.color} ${e.role}`;function bo(e){var t,n,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const a of e.lastMove)J(r,a,"last-move");if(e.check&&e.highlight.check&&J(r,e.check,"check"),e.selected&&(J(r,e.selected,"selected"),e.movable.showDests)){const a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(const c of a)J(r,c,"move-dest"+(e.pieces.has(c)?" oc":""));const f=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(f)for(const c of f)J(r,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}const o=e.premovable.current;if(o)for(const a of o)J(r,a,"current-premove");else e.predroppable.current&&J(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const a of s.keys)J(r,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,f)=>{J(r,f,a)}),r}function J(e,t,n){const i=e.get(t);i?e.set(t,`${i} ${n}`):e.set(t,n)}function rt(e,t,n){const i=e.get(t);i?i.push(n):e.set(t,[n])}function wo(e,t,n){const i=new Map,r=[];for(const a of e)i.set(a.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),i.has(s)?i.set(s,!0):r.push(o),o=o.nextElementSibling;for(const a of r)t.removeChild(a);for(const a of e)i.get(a.hash)||t.appendChild(n(a))}function yo(e,t){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:ko(r),current:!1}));wo(i,t,r=>So(e,r,e.dom.bounds()))}function Co(e){var t;const n=H(e),i=xe(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)rn(r,i(M(r.cgKey),n),r.cgScale),r=r.nextSibling}function So(e,{shape:t,hash:n},i){var r,o,s;const a=t.orig,f=(r=t.piece)===null||r===void 0?void 0:r.role,c=(o=t.piece)===null||o===void 0?void 0:o.color,p=(s=t.piece)===null||s===void 0?void 0:s.scale,g=ee("piece",`${f} ${c}`);return g.setAttribute("cgHash",n),g.cgKey=a,g.cgScale=p,rn(g,xe(i)(M(a),H(e)),p),g}const ko=e=>{var t,n,i;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function Eo(e,t){const n=Vr();yn(n,t||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=uo(e,n),s=cr(()=>o.board.getBoundingClientRect()),a=p=>{vo(c),o.autoPieces&&yo(c,o.autoPieces),!p&&o.svg&&Zr(c,o.svg,o.customSvg)},f=()=>{Xt(c),_o(c),o.autoPieces&&Co(c)},c=n;return c.dom={elements:o,bounds:s,redraw:Po(a),redrawNow:a,unbind:r},c.drawable.prevSvgHash="",Xt(c),a(!1),po(c,f),r||(c.dom.unbind=go(c,f)),c.events.insert&&c.events.insert(o),c}return zr(i(),i)}function Po(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}const Ao={class:""},$o={class:"text-center my-4 text-lg font-semibold text-white min-h-12"},Mo={class:"mt-6 text-center"},xo={class:"bg-gray-800 text-white p-4 rounded w-full max-w-md mx-auto overflow-x-auto min-h-14"},en="r3rk2/pbpq1p2/3b1Q1p/np2p3/4P2N/1BP4P/PP3PP1/3RR1K1 w - - 0 1",No={__name:"ChessView",setup(e){const t=ze(),n=ze(""),i=ze(""),r=new sr(en),o=["Ng6+","Qh8#"];let s=null,a=0;const f=Oi(()=>n.value!=null?n.value.split(`
`).filter(b=>!b.startsWith("[")&&b.trim()!=="").join(" ").replace(/\d+\.\s*/g,"").replace(/\s*\*\s*$/,"").trim():"");function c(){const b=new Map,w=r.SQUARES||["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2","a3","b3","c3","d3","e3","f3","g3","h3","a4","b4","c4","d4","e4","f4","g4","h4","a5","b5","c5","d5","e5","f5","g5","h5","a6","b6","c6","d6","e6","f6","g6","h6","a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"];for(const A of w){const x=r.moves({square:A,verbose:!0});x.length&&b.set(A,x.map(T=>T.to))}return b}function p(){s.set({fen:r.fen(),turnColor:r.turn()==="w"?"white":"black",movable:{free:!1,dests:c(),color:r.turn()==="w"?"white":"black",events:{after:(b,w)=>g(b,w)}}}),n.value=r.pgn()}function g(b,w){const A=r.move({from:b,to:w,promotion:"q"});if(!A)return;const x=A.san.replace(/[+#]/g,""),T=o[a].replace(/[+#]/g,"");if(x!==T){i.value=" !",s.cancelMove?.(),r.undo(),p();return}x==="Ng6"?(i.value="",s.set({movable:{color:"none",dests:new Map}}),setTimeout(()=>{r.move({from:"f8",to:"g8"}),a++,p()},300)):(a++,p(),a===o.length&&setTimeout(()=>{i.value="  ! !"},200))}function m(){i.value="",r.reset(),r.load(en),a=0,p()}function v(){i.value="",s.cancelMove?.(),r.undo(),a=Math.max(0,a-1),p()}return Ki(()=>{s=Eo(t.value,{fen:r.fen(),movable:{free:!1,dests:c(),color:"white",events:{after:(b,w)=>g(b,w)}}}),n.value=r.pgn()}),(b,w)=>(qi(),Ii("div",Ao,[ue("div",$o,Ft(i.value),1),ue("div",{ref_key:"boardEl",ref:t,class:"aspect-square border border-gray-300 mx-auto"},null,512),ue("div",{class:"flex justify-center gap-4 mt-4"},[ue("button",{onClick:m,class:"bg-blue-600 text-white px-4 py-2 rounded"},"Reset"),ue("button",{onClick:v,class:"bg-gray-700 text-white px-4 py-2 rounded"},"Undo")]),ue("div",Mo,[ue("pre",xo,Ft(f.value),1)])]))}};export{No as default};
